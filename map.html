<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Map</title>
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=0xpjl9940x"></script>
    <style>
        body, html { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; }
        #map { width: 100%; height: 100%; }
        
        /* 마커 스타일 (기존 유지) */
        .marker-pin {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #FF0000;
            border: 2px solid #FFFFFF;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.5);
            text-align: center;
            line-height: 26px;
            color: white;
            font-weight: bold;
            font-family: Arial, sans-serif;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .marker-pin:hover {
            transform: scale(1.2);
            z-index: 999;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        var map = null;
        var markers = []; 
        var polylines = []; // [추가] 그려진 선들을 관리할 배열

        function initMap() {
            map = new naver.maps.Map('map', {
                center: new naver.maps.LatLng(37.057202, 127.048285),
                zoom: 12
            });
        }

        function addMarker(lat, lng, gridIndex, tooltip) {
            var displayNum = gridIndex + 1;
            var contentHtml = '<div class="marker-pin" title="' + tooltip + '">' + displayNum + '</div>';

            var marker = new naver.maps.Marker({
                position: new naver.maps.LatLng(lat, lng),
                map: map,
                icon: {
                    content: contentHtml,
                    size: new naver.maps.Size(30, 30),
                    anchor: new naver.maps.Point(15, 15)
                }
            });

            naver.maps.Event.addListener(marker, 'click', function(e) {
                if (window.chrome && window.chrome.webview) {
                    window.chrome.webview.postMessage(gridIndex.toString());
                }
            });

            markers.push(marker);
            
            if (markers.length === 1) {
                map.setCenter(new naver.maps.LatLng(lat, lng));
            }
        }

        // [신규 기능] 마커들을 순서대로 잇는 빨간 화살표 선 그리기
        function drawConnectors() {
            // 기존 선 삭제
            for (var i = 0; i < polylines.length; i++) {
                polylines[i].setMap(null);
            }
            polylines = [];

            // 마커가 2개 이상일 때만 연결
            if (markers.length < 2) return;

            // 구간별로 선을 그립니다 (0->1, 1->2, 2->3 ...)
            for (var i = 0; i < markers.length - 1; i++) {
                var start = markers[i].getPosition();
                var end = markers[i + 1].getPosition();

                var polyline = new naver.maps.Polyline({
                    map: map,
                    path: [start, end],      // 시작점 -> 끝점
                    strokeColor: '#FF0000',  // 빨간색
                    strokeWeight: 4,         // 선 두께
                    strokeOpacity: 0.8,      // 투명도
                    strokeStyle: 'solid',    
                    endIcon: naver.maps.PointingIcon.OPEN_ARROW, // 끝에 화살표
                    endIconSize: 20          // 화살표 크기
                });

                polylines.push(polyline);
            }
        }

        // [수정] 마커 지울 때 선도 같이 삭제
        function clearAllMarkers() {
            for (var i = 0; i < markers.length; i++) {
                markers[i].setMap(null);
            }
            markers = [];

            for (var j = 0; j < polylines.length; j++) {
                polylines[j].setMap(null);
            }
            polylines = [];
        }

        initMap();
    </script>
</body>
</html>
